{"version":3,"sources":["../src/utils.ts"],"sourcesContent":["import { access } from 'node:fs/promises';\nimport { dirname, join } from 'node:path';\nimport type { Application } from 'express';\n\nexport interface ExpressLayer {\n\troute?: {\n\t\tpath: string;\n\t\tmethods: Record<string, boolean>;\n\t};\n\tname: string;\n\thandle?: {\n\t\tstack?: ExpressLayer[];\n\t};\n\tregexp?: RegExp;\n}\n\nexport interface RouteInfo {\n\tmethod: string;\n\tpath: string;\n}\n\nexport function* extractRoutes(app: Application): Generator<RouteInfo> {\n\tconst routerStack =\n\t\t(app as Application)._router?.stack ??\n\t\t(app as Application).router?.stack;\n\n\tif (!routerStack || !Array.isArray(routerStack)) return;\n\n\tfor (const layer of routerStack as ExpressLayer[]) {\n\t\tif (!layer) continue;\n\n\t\tif (layer.route?.path && layer.route.methods) {\n\t\t\tfor (const method of Object.keys(layer.route.methods)) {\n\t\t\t\tyield { method: method.toUpperCase(), path: layer.route.path };\n\t\t\t}\n\t\t} else if (\n\t\t\tlayer.name === 'router' &&\n\t\t\tlayer.handle?.stack &&\n\t\t\tArray.isArray(layer.handle.stack)\n\t\t) {\n\t\t\tconst prefix =\n\t\t\t\tlayer.regexp?.source\n\t\t\t\t\t?.replace('\\\\/?(?=\\\\/|$)', '')\n\t\t\t\t\t.replace('^', '')\n\t\t\t\t\t.replace('$', '') || '';\n\n\t\t\tfor (const nested of layer.handle.stack) {\n\t\t\t\tif (nested?.route?.path && nested.route.methods) {\n\t\t\t\t\tfor (const method of Object.keys(nested.route.methods)) {\n\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\tmethod: method.toUpperCase(),\n\t\t\t\t\t\t\tpath: prefix + nested.route.path,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport async function findProjectRoot(\n\tstartDir: string,\n): Promise<string | null> {\n\tlet dir = startDir;\n\twhile (true) {\n\t\ttry {\n\t\t\tconst pkgPath = join(dir, 'package.json');\n\t\t\tawait access(pkgPath);\n\t\t\treturn dir;\n\t\t} catch {\n\t\t\tconst parent = dirname(dir);\n\t\t\tif (parent === dir) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tdir = parent;\n\t\t}\n\t}\n}\n"],"mappings":"AAAA,OAAS,UAAAA,MAAc,cACvB,OAAS,WAAAC,EAAS,QAAAC,MAAY,OAoBvB,SAAUC,EAAcC,EAAwC,CACtE,IAAMC,EACJD,EAAoB,SAAS,OAC7BA,EAAoB,QAAQ,MAE9B,GAAI,GAACC,GAAe,CAAC,MAAM,QAAQA,CAAW,IAE9C,QAAWC,KAASD,EACnB,GAAKC,GAEL,GAAIA,EAAM,OAAO,MAAQA,EAAM,MAAM,QACpC,QAAWC,KAAU,OAAO,KAAKD,EAAM,MAAM,OAAO,EACnD,KAAM,CAAE,OAAQC,EAAO,YAAY,EAAG,KAAMD,EAAM,MAAM,IAAK,UAG9DA,EAAM,OAAS,UACfA,EAAM,QAAQ,OACd,MAAM,QAAQA,EAAM,OAAO,KAAK,EAC/B,CACD,IAAME,EACLF,EAAM,QAAQ,QACX,QAAQ,gBAAiB,EAAE,EAC5B,QAAQ,IAAK,EAAE,EACf,QAAQ,IAAK,EAAE,GAAK,GAEvB,QAAWG,KAAUH,EAAM,OAAO,MACjC,GAAIG,GAAQ,OAAO,MAAQA,EAAO,MAAM,QACvC,QAAWF,KAAU,OAAO,KAAKE,EAAO,MAAM,OAAO,EACpD,KAAM,CACL,OAAQF,EAAO,YAAY,EAC3B,KAAMC,EAASC,EAAO,MAAM,IAC7B,CAIJ,GAEF,CAEA,eAAsBC,EACrBC,EACyB,CACzB,IAAIC,EAAMD,EACV,OACC,GAAI,CACH,IAAME,EAAUX,EAAKU,EAAK,cAAc,EACxC,aAAMZ,EAAOa,CAAO,EACbD,CACR,MAAQ,CACP,IAAME,EAASb,EAAQW,CAAG,EAC1B,GAAIE,IAAWF,EACd,OAAO,KAERA,EAAME,CACP,CAEF","names":["access","dirname","join","extractRoutes","app","routerStack","layer","method","prefix","nested","findProjectRoot","startDir","dir","pkgPath","parent"]}