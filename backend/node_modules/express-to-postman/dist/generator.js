import{readFile as x,unlink as k,writeFile as w}from"fs/promises";import{basename as j,dirname as A,join as u}from"path";import{pathToFileURL as R}from"url";import{build as b}from"esbuild";import{access as h}from"fs/promises";import{dirname as g,join as y}from"path";function*l(o){let e=o._router?.stack??o.router?.stack;if(!(!e||!Array.isArray(e))){for(let t of e)if(t){if(t.route?.path&&t.route.methods)for(let a of Object.keys(t.route.methods))yield{method:a.toUpperCase(),path:t.route.path};else if(t.name==="router"&&t.handle?.stack&&Array.isArray(t.handle.stack)){let a=t.regexp?.source?.replace("\\/?(?=\\/|$)","").replace("^","").replace("$","")||"";for(let r of t.handle.stack)if(r?.route?.path&&r.route.methods)for(let n of Object.keys(r.route.methods))yield{method:n.toUpperCase(),path:a+r.route.path}}}}}async function f(o){let e=o;for(;;)try{let t=y(e,"package.json");return await h(t),e}catch{let t=g(e);if(t===e)return null;e=t}}async function $(o){let e=A(o),t=u(e,`${j(o,".ts")}-${Date.now()}.js`),a=await f(e)||e,r=u(a,"package.json"),n=[];try{let i=JSON.parse(await x(r,"utf-8"));n=Object.keys(i.dependencies||{})}catch{}await b({entryPoints:[o],outfile:t,bundle:!0,format:"esm",platform:"node",external:[...n]});let s=await import(R(t).href);return await k(t),s}async function J(o,e,t){let r=(await $(o)).app;if(!r)throw new Error(`No named export "app" found in ${o}`);let n={info:{name:o.split(/[\\/]/).pop()||"Express App",schema:"https://schema.getpostman.com/json/collection/v2.1.0/collection.json"},item:[]},s={};console.log(" extractRoutes(app as Application): ",l(r));for(let{method:i,path:c}of l(r)){let m=c.split("/").filter(Boolean),p=m[0]||"/";s[p]||(s[p]={name:p,item:[]});let d={name:`${i} ${c}`,request:{method:i,header:[],url:{raw:`{{baseUrl}}${c}`,host:["{{baseUrl}}"],path:m}}};s[p].item.push(d)}for(let i of Object.keys(s))n.item.push(s[i]);t&&console.log(JSON.stringify(n,null,2)),await w(e,JSON.stringify(n,null,2),"utf-8")}export{J as generateCollection,$ as loadApp};
//# sourceMappingURL=generator.js.map